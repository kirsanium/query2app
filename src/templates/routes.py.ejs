import os
import psycopg2

from fastapi import APIRouter

router = APIRouter()

<%
// { "get", "/v1/categories/:categoryId" } => "get_v1_categories_category_id"
function generate_method_name(method, path) {
    const name = camel2snakeCase(path).replace(/\//g, '_').replace(/[^_a-z0-9]/g, '');
    return `${method}${name}`
}

// "/categories/:categoryId" => "/categories/{categoryId}"
function convertToFastApiPath(path) {
    return path.replace(/:([_a-zA-Z]+)/g, '{$1}')
}


endpoints.forEach(function(endpoint) {
    const path = convertToFastApiPath(endpoint.path)

    endpoint.methods.forEach(function(method) {
        const hasGetOne = method.name === 'get'
        const hasGetMany = method.name === 'get_list'
        const pythonMethodName = generate_method_name(method.name, path)
        const sql = formatQuery(method.query)

        if (hasGetOne || hasGetMany) {
%>
@router.get('<%- path %>')
def <%- pythonMethodName %>():
<%          if (hasGetOne) { -%>
    conn = psycopg2.connect(
        database = os.getenv('DB_NAME'),
        user = os.getenv('DB_USER'),
        password = os.getenv('DB_PASSWORD'),
        host = os.getenv('DB_HOST', 'localhost'),
        port = 5432)
    try:
        with conn:
            with conn.cursor() as cur:
                cur.execute('<%- sql %>')
                return cur.fetchone()[0]
    finally:
        conn.close()
<%
            } else {
-%>
    pass
<%
            }
        }
        if (method.name === 'post') {
%>
@router.post('<%- path %>')
def <%- pythonMethodName %>():
    pass
<%

        }
        if (method.name === 'put') {
%>
@router.put('<%- path %>')
def <%- pythonMethodName %>():
    pass
<%

        }
        if (method.name === 'delete') {
%>
@router.delete('<%- path %>')
def <%- pythonMethodName %>():
    pass
<%

        }
    })
})
%>
